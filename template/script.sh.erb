#!/bin/bash

# Benchmark info
echo "TIMING - Starting main script at: $(date)"

export SESSION_DIR="${PWD}"

# Set working directory to home directory
cd "${HOME}"

# TODO: NeSI/zen3 was not loaded, look into it
echo "list modules:"
ml
echo "load NeSI/zen3"
ml NeSI/zen3
echo "list modules:"
ml

#
# Start Pluto.ji Server
#

# Purge the module environment to avoid conflicts
module purge

# Load the require modules
#module load <%= context.pluto_module %>
module load Python/3.11.6-foss-2023a

## Fix terminal colors for ls command with a wrapper script for system ls
mkdir -p ~/ondemand/ood_bin
cat > ~/ondemand/ood_bin/ls <<'EOF'
#!/bin/bash
/usr/bin/ls --color=auto "$@"
EOF

chmod +x ~/ondemand/ood_bin/ls
export PATH="$HOME/ondemand/ood_bin:$PATH"
    
# temporary workaround: custom kernels created on mahuika with our tool include "module load slurm"
# but there is currently no slurm module on the new platform; this should be removed later when
# there is a slurm module or we have a better solution
export MODULEPATH=${MODULEPATH}:${SESSION_DIR}/modules

# unload the OpenSSL module as it does not work properly (has a broken symbolic link)
# however the OpenSSL installed in the docker image works fine
# NOTE: may need to check this whenever the docker image is updated
# TODO: check if needed with newly built pluto modules; not sure if needed in hpc context
ml -OpenSSL

# List loaded modules
module list

# Benchmark info
echo "TIMING - Starting pluto at: $(date)"

# set PYTHON_PATH to include shared custom kernels created by nesi-add-kernel
export PYTHON_PATH=/nesi/project/${PYTHON_JOB_ACCOUNT}/.pluto/share/pluto:${PYTHON_PATH}
echo "Extending PYTHON_PATH to include shared kernels from \"/nesi/project/${PYTHON_JOB_ACCOUNT}\""

# Launch the Pluto Notebook Server
set -x

# 1. Assign OOD variables (these are provided by the framework)
# NOTE: OOD variables are typically lowercase in the ERB template

#julia -e 'using Pluto; Pluto.run( Pluto.ServerSession( secret=ENV["password"], options=Pluto.Configuration.from_flat_kwargs( host="0.0.0.0", port=parse(Int, ENV["pluto_port"]), base_url="/node/$(ENV["host"])/$(ENV["PORT_CFG"])/" ) ) ) ' 


pip install marimo
marimo edit \
  --no-token \
  --headless \
  --host 0.0.0.0 \
  --port ${MARINO_PORT} \
  --base-url /node/${host}/${PORT_CFG} 

